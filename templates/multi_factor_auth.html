{% extends "base.html" %}

{% block title %}Multi-Factor Authentication - ABSA Bank{% endblock %}

{% block extra_css %}
<style>
  .progress {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
  }

  .progress-step {
    flex: 1;
    position: relative;
    text-align: center;
    font-size: 13px;
    color: var(--text-light);
  }

  .progress-step::before {
    content: "";
    display: block;
    width: 100%;
    height: 3px;
    background: var(--border);
    position: absolute;
    top: 8px;
    left: -50%;
    z-index: -1;
  }

  .progress-step:first-child::before {
    display: none;
  }

  .progress-step.active {
    color: var(--primary);
    font-weight: bold;
  }

  .progress-step.completed {
    color: var(--primary);
  }

  .progress-step.completed::before {
    background: var(--primary);
  }

  .progress-step.active::before {
    background: var(--primary);
  }

  .progress-step span {
    display: inline-block;
    width: 20px;
    height: 20px;
    line-height: 20px;
    border-radius: 50%;
    background: var(--primary);
    color: #fff;
    font-size: 12px;
    margin-bottom: 5px;
  }

  h2 {
    font-size: 20px;
    margin-bottom: 20px;
    font-weight: normal;
  }

  .verification-notice {
    background: #f8f9fa;
    border-left: 4px solid var(--accent);
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
  }

  .verification-notice h4 {
    margin: 0 0 8px 0;
    color: var(--primary);
    font-size: 16px;
  }

  .verification-notice p {
    margin: 0;
    font-size: 14px;
    color: var(--text-light);
  }

  .auth-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }

  .auth-method {
    background: #fff;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 2px solid var(--border);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .auth-method:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
  }

  .auth-method.selected {
    border-color: var(--primary);
    background: rgba(139, 21, 56, 0.05);
  }

  .auth-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }

  .auth-icon {
    width: 50px;
    height: 50px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 24px;
    color: white;
  }

  .auth-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-dark);
  }

  .auth-description {
    color: var(--text-light);
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 15px;
  }

  .auth-form {
    display: none;
    margin-top: 20px;
  }

  .auth-form.active {
    display: block;
  }

  label {
    display: block;
    font-size: 14px;
    margin-bottom: 5px;
    font-weight: 600;
  }

  input, select {
    width: 100%;
    padding: 8px 10px;
    font-size: 14px;
    border: 1px solid var(--border);
    border-radius: 3px;
    box-sizing: border-box;
    margin-bottom: 15px;
  }

  .account-input {
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
  }

  .otp-container {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    justify-content: center;
  }

  .otp-input {
    width: 60px;
    height: 60px;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    border: 2px solid var(--border);
    border-radius: 8px;
    background-color: #fafafa;
    transition: all 0.3s ease;
  }

  .otp-input:focus {
    border-color: var(--primary);
    background-color: #fff;
    box-shadow: 0 0 0 3px rgba(139, 21, 56, 0.1);
  }

  .timer {
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    color: var(--accent);
    margin: 15px 0;
  }

  .resend-link {
    color: var(--primary);
    cursor: pointer;
    text-decoration: underline;
    font-size: 14px;
  }

  .resend-link:hover {
    color: var(--accent);
  }

  .resend-link.disabled {
    color: var(--text-light);
    cursor: not-allowed;
    text-decoration: none;
  }

  .buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  }

  .buttons .cancel {
    background: #fff;
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 8px 18px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .buttons .verify {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 8px 22px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .buttons .verify:hover {
    background: #e55b00;
  }

  .buttons .verify:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .security-tips {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
  }

  .security-tips h4 {
    margin: 0 0 15px 0;
    color: var(--primary);
    font-size: 16px;
  }

  .security-tips ul {
    margin: 0;
    padding-left: 20px;
  }

  .security-tips li {
    color: var(--text-light);
    font-size: 14px;
    margin-bottom: 8px;
  }

  @media (max-width: 768px) {
    .auth-container {
      grid-template-columns: 1fr;
      gap: 20px;
    }
    .otp-container {
      justify-content: center;
    }
    .buttons {
      flex-direction: column;
    }
    .buttons button {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="progress">
  <div class="progress-step completed"><span>1</span><br>Customer Information</div>
  <div class="progress-step completed"><span>2</span><br>SurePhrase</div>
  <div class="progress-step completed"><span>3</span><br>PIN Entry</div>
  <div class="progress-step active"><span>4</span><br>Additional Security</div>
</div>

<h2>Additional Security Verification</h2>

<div class="verification-notice">
  <h4>Enhanced Security Required</h4>
  <p>For your protection, we need to verify your identity using one of the methods below. Choose your preferred verification method.</p>
</div>

<div class="auth-container">
  <div class="auth-method" data-method="sms">
    <div class="auth-header">
      <div class="auth-icon">ðŸ“±</div>
      <div class="auth-title">SMS Verification</div>
    </div>
    <div class="auth-description">
      Receive a 6-digit verification code via SMS to your registered mobile number ending in ****7890.
    </div>
    <div class="auth-form" id="smsForm">
      <div>
        <label for="smsAccount">Account Number *</label>
        <input type="text" id="smsAccount" class="account-input" placeholder="Enter your account number" maxlength="10" required>
      </div>
      <div>
        <label for="smsPhone">Mobile Number *</label>
        <input type="tel" id="smsPhone" placeholder="+27 *** *** 7890" readonly value="+27 *** *** 7890">
      </div>
      <button type="button" id="sendSMS" class="buttons verify" style="width: 100%; margin: 10px 0;">Send SMS Code</button>
      
      <div id="smsCodeSection" style="display: none;">
        <label>Enter 6-digit SMS Code:</label>
        <div class="otp-container">
          <input type="text" class="otp-input sms-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input sms-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input sms-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input sms-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input sms-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input sms-otp" maxlength="1" inputmode="numeric">
        </div>
        <div class="timer" id="smsTimer">Code expires in: <span id="smsCountdown">05:00</span></div>
        <div style="text-align: center;">
          <span class="resend-link" id="resendSMS">Resend SMS Code</span>
        </div>
      </div>
    </div>
  </div>

  <div class="auth-method" data-method="email">
    <div class="auth-header">
      <div class="auth-icon">ðŸ“§</div>
      <div class="auth-title">Email Verification</div>
    </div>
    <div class="auth-description">
      Receive a secure verification code via email to your registered email address ending in ****@gmail.com.
    </div>
    <div class="auth-form" id="emailForm">
      <div>
        <label for="emailAccount">Account Number *</label>
        <input type="text" id="emailAccount" class="account-input" placeholder="Enter your account number" maxlength="10" required>
      </div>
      <div>
        <label for="userEmail">Email Address *</label>
        <input type="email" id="userEmail" placeholder="****@gmail.com" readonly value="john.doe****@gmail.com">
      </div>
      <button type="button" id="sendEmail" class="buttons verify" style="width: 100%; margin: 10px 0;">Send Email Code</button>
      
      <div id="emailCodeSection" style="display: none;">
        <label>Enter 6-digit Email Code:</label>
        <div class="otp-container">
          <input type="text" class="otp-input email-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input email-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input email-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input email-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input email-otp" maxlength="1" inputmode="numeric">
          <input type="text" class="otp-input email-otp" maxlength="1" inputmode="numeric">
        </div>
        <div class="timer" id="emailTimer">Code expires in: <span id="emailCountdown">05:00</span></div>
        <div style="text-align: center;">
          <span class="resend-link" id="resendEmail">Resend Email Code</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="buttons">
  <button type="button" class="cancel" id="backBtn">Back</button>
  <button type="submit" class="verify" id="finalVerify" disabled>Complete Verification</button>
</div>

<div class="security-tips">
  <h4>Security Tips</h4>
  <ul>
    <li>Never share your verification codes with anyone</li>
    <li>ABSA will never ask for your PIN or password via SMS or email</li>
    <li>If you didn't request this verification, contact us immediately</li>
    <li>Codes expire after 5 minutes for your security</li>
    <li>You can only use each code once</li>
  </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
  let selectedMethod = null;
  let smsTimer = null;
  let emailTimer = null;

  // Method selection
  document.querySelectorAll('.auth-method').forEach(method => {
    method.addEventListener('click', function() {
      // Remove previous selection
      document.querySelectorAll('.auth-method').forEach(m => {
        m.classList.remove('selected');
        m.querySelector('.auth-form').classList.remove('active');
      });
      
      // Select new method
      this.classList.add('selected');
      this.querySelector('.auth-form').classList.add('active');
      selectedMethod = this.dataset.method;
    });
  });

  // Back button
  document.getElementById('backBtn').addEventListener('click', function() {
    window.history.back();
  });

  // SMS functionality
  document.getElementById('sendSMS').addEventListener('click', async function() {
    const account = document.getElementById('smsAccount').value;
    if (!account || account.length !== 10) {
      alert('Please enter a valid 10-digit account number');
      return;
    }
    
    this.textContent = 'Sending...';
    this.disabled = true;
    
    try {
      const response = await fetch('/send-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          method: 'sms',
          account_number: account
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        document.getElementById('smsCodeSection').style.display = 'block';
        this.textContent = 'Code Sent';
        startTimer('sms');
        
        // For demo purposes, show the OTP
        if (data.debug_code) {
          console.log('SMS OTP:', data.debug_code);
          alert('Demo Mode: Your SMS code is ' + data.debug_code);
        }
      } else {
        alert(data.message);
        this.textContent = 'Send SMS Code';
        this.disabled = false;
      }
    } catch (error) {
      alert('Error sending SMS code');
      this.textContent = 'Send SMS Code';
      this.disabled = false;
    }
  });

  // Email functionality
  document.getElementById('sendEmail').addEventListener('click', async function() {
    const account = document.getElementById('emailAccount').value;
    if (!account || account.length !== 10) {
      alert('Please enter a valid 10-digit account number');
      return;
    }
    
    this.textContent = 'Sending...';
    this.disabled = true;
    
    try {
      const response = await fetch('/send-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          method: 'email',
          account_number: account
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        document.getElementById('emailCodeSection').style.display = 'block';
        this.textContent = 'Code Sent';
        startTimer('email');
        
        // For demo purposes, show the OTP
        if (data.debug_code) {
          console.log('Email OTP:', data.debug_code);
          alert('Demo Mode: Your Email code is ' + data.debug_code);
        }
      } else {
        alert(data.message);
        this.textContent = 'Send Email Code';
        this.disabled = false;
      }
    } catch (error) {
      alert('Error sending email code');
      this.textContent = 'Send Email Code';
      this.disabled = false;
    }
  });

  // OTP input handling
  function setupOTPInputs(className) {
    const inputs = document.querySelectorAll(`.${className}`);
    inputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const value = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = value;
        
        if (value && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
        
        checkOTPComplete(className);
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && input.value === '' && index > 0) {
          inputs[index - 1].focus();
        }
      });
    });
  }

  setupOTPInputs('sms-otp');
  setupOTPInputs('email-otp');

  function checkOTPComplete(className) {
    const inputs = document.querySelectorAll(`.${className}`);
    const complete = Array.from(inputs).every(input => input.value !== '');
    document.getElementById('finalVerify').disabled = !complete;
  }

  // Timer functionality
  function startTimer(type) {
    let timeLeft = 300; // 5 minutes
    const countdownElement = document.getElementById(`${type}Countdown`);
    const resendElement = document.getElementById(`resend${type.charAt(0).toUpperCase() + type.slice(1)}`);
    
    resendElement.classList.add('disabled');
    
    const timer = setInterval(() => {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      if (timeLeft <= 0) {
        clearInterval(timer);
        countdownElement.textContent = '00:00';
        resendElement.classList.remove('disabled');
        resendElement.textContent = 'Code Expired - Resend';
      }
      
      timeLeft--;
    }, 1000);

    if (type === 'sms') smsTimer = timer;
    if (type === 'email') emailTimer = timer;
  }

  // Final verification
  document.getElementById('finalVerify').addEventListener('click', async function() {
    const otpInputs = selectedMethod === 'sms' ? 
      document.querySelectorAll('.sms-otp') : 
      document.querySelectorAll('.email-otp');
    
    const otp = Array.from(otpInputs).map(input => input.value).join('');
    
    if (otp.length !== 6) {
      alert('Please enter the complete 6-digit code');
      return;
    }
    
    this.textContent = 'Verifying...';
    this.disabled = true;
    
    try {
      const response = await fetch('/verify-otp', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          method: selectedMethod,
          otp: otp
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('Verification successful! Redirecting to your account...');
        window.location.href = '/account-access';
      } else {
        alert(data.message);
        this.textContent = 'Complete Verification';
        this.disabled = false;
      }
    } catch (error) {
      alert('Error verifying code');
      this.textContent = 'Complete Verification';
      this.disabled = false;
    }
  });

  // Account number formatting
  document.querySelectorAll('.account-input').forEach(input => {
    input.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      e.target.value = value;
    });
  });
</script>
{% endblock %}